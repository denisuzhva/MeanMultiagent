package main.java.ru.denisuzhva.multiAgentAverage;

import jade.core.Agent;
import jade.core.AID;
import jade.core.behaviours.*;
import jade.lang.acl.ACLMessage;
import jade.lang.acl.MessageTemplate;
//import jade.tools.sniffer.Message;

import java.util.*;



public class EnvAgent extends Agent {

	private String selfId;
    private String consensusStateConvId;
	

	@Override
	protected void setup() {
		consensusStateConvId = "consensus-state";
		selfId = getAID().getLocalName();
        System.out.println("Agent " + selfId + " is ready");

		addBehaviour(new StateTranslator());
		addBehaviour(new PoolTranslator());
		addBehaviour(new StateRefillTranslator());
	}


	@Override
    protected void takeDown() {
        System.out.println("Agent " + selfId + " is terminating");
    }


	private class StateTranslator extends CyclicBehaviour {

		private float inState;
		private float outState;

		public void action() {
			MessageTemplate mt = MessageTemplate.and(MessageTemplate.MatchPerformative(ACLMessage.PROPAGATE), 
					MessageTemplate.MatchConversationId(consensusStateConvId));
			ACLMessage stateMsg = myAgent.receive(mt);
			if (stateMsg != null) {
				String msgContent = stateMsg.getContent();
				String[] contentList = msgContent.split(" ");
				inState = Float.parseFloat(contentList[0]);

				// do noizy stuff here
				Random rand = new Random();
				float nxtNormal = (float)rand.nextGaussian();
				outState = inState + nxtNormal;
				float nxtUni = rand.nextFloat();
				

				ACLMessage stateFurther = new ACLMessage(ACLMessage.PROPAGATE);
				stateFurther.setContent(String.valueOf(outState));
				stateFurther.setConversationId(consensusStateConvId);
				stateFurther.setReplyWith(stateMsg.getReplyWith());
				stateFurther.setSender(stateMsg.getSender());
				for (int i = 1; i < contentList.length; i++) {
					String contentEnt = contentList[i];
					stateFurther.addReceiver(new AID(contentEnt, AID.ISLOCALNAME));
				}
				myAgent.send(stateFurther);
			}
		}
	}


	private class PoolTranslator extends CyclicBehaviour {

		private float inPool;
		private float outPoolDist;
		private int numNeigh;

		public void action() {
			MessageTemplate mt = MessageTemplate.and(MessageTemplate.MatchPerformative(ACLMessage.PROPOSE), 
					MessageTemplate.MatchConversationId(consensusStateConvId));
			ACLMessage poolMsg = myAgent.receive(mt);
			if (poolMsg != null) {
				String msgContent = poolMsg.getContent();
				String[] contentList = msgContent.split(" ");
				inPool = Float.parseFloat(contentList[0]);
				numNeigh = contentList.length - 1;

				// do noizy stuff here
				outPoolDist = inPool / numNeigh;

				ACLMessage poolFurther = new ACLMessage(ACLMessage.PROPOSE);
				poolFurther.setContent(String.valueOf(outPoolDist));
				poolFurther.setConversationId(consensusStateConvId);
				poolFurther.setReplyWith(poolMsg.getReplyWith());
				poolFurther.setSender(poolMsg.getSender());
				for (int i = 1; i < contentList.length; i++) {
					String contentEnt = contentList[i];
					poolFurther.addReceiver(new AID(contentEnt, AID.ISLOCALNAME));
				}
				myAgent.send(poolFurther);
			}
		}
	}


	private class StateRefillTranslator extends CyclicBehaviour {

		private float inRefill;
		private float outRefill;
		private String msgContent;
		private String[] contentList;
		private String recipient;


		public void action() {
			MessageTemplate mt = MessageTemplate.and(MessageTemplate.or(MessageTemplate.MatchPerformative(ACLMessage.ACCEPT_PROPOSAL),
						MessageTemplate.MatchPerformative(ACLMessage.REJECT_PROPOSAL)),
					MessageTemplate.MatchConversationId(consensusStateConvId));
			ACLMessage refillMsg = myAgent.receive(mt);
			if (refillMsg != null) {
				msgContent = refillMsg.getContent();
				contentList = msgContent.split(" ");
				inRefill = Float.parseFloat(contentList[0]);
				recipient = contentList[1];

				// do noizy stuff here
				outRefill = inRefill; 

				ACLMessage refillFurther = new ACLMessage(ACLMessage.INFORM);
				refillFurther.setContent(String.valueOf(outRefill));
				refillFurther.setConversationId(consensusStateConvId);
				refillFurther.setReplyWith(refillMsg.getReplyWith());
				refillFurther.setSender(refillMsg.getSender());
				refillFurther.addReceiver(new AID(recipient, AID.ISLOCALNAME));
				myAgent.send(refillFurther);
			}
		}
	}
}
